<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ephemeral - Anonymous Social Network</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .post {
            transition: all 0.3s ease;
        }
        .post:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .expiring {
            position: relative;
        }
        .expiring:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, #f56565, transparent);
            animation: progress 86400s linear forwards;
        }
        @keyframes progress {
            0% { width: 100%; }
            100% { width: 0%; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="gradient-bg min-h-screen">
        <!-- Header -->
        <header class="bg-white bg-opacity-10 backdrop-blur-sm shadow-sm sticky top-0 z-10">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <img src="https://placehold.co/40" alt="Ephemeral logo - hourglass with sand flowing through it in purple gradient colors" class="rounded-full">
                    <h1 class="text-2xl font-bold text-white">Ephemeral</h1>
                </div>
                <div class="text-white">
                    <span class="hidden md:inline">Posts disappear in 24 hours</span>
                    <span class="md:hidden">24h</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Post Creation -->
            <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-lg shadow-lg p-6 mb-8 fade-in">
                <h2 class="text-xl font-semibold text-white mb-4">Share something anonymously</h2>
                <textarea id="postContent" class="w-full p-4 rounded-lg border border-gray-300 bg-white bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="What's on your mind? (Max 500 characters)" maxlength="500" rows="4"></textarea>
                <div class="flex justify-between items-center mt-4">
                    <div class="text-xs text-white">
                        <span id="charCounter">0</span>/500
                    </div>
                    <button id="postButton" class="bg-white text-purple-600 font-semibold py-2 px-6 rounded-lg hover:bg-gray-100 transition duration-200 flex items-center space-x-2">
                        <span>Post</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Posts Feed -->
            <div class="space-y-6" id="postsContainer">
                <div class="bg-white rounded-lg shadow-lg p-6 fade-in">
                    <p class="text-gray-700">Loading posts...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://xuvniwctteaqoygfbaub.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1dm5pd2N0dGVhcW95Z2ZiY3ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTk1MDQ0NDksImV4cCI6MjAxNTA4MDQ0OX0.5Z1kz1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X1X';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // DOM elements
        const postContent = document.getElementById('postContent');
        const postButton = document.getElementById('postButton');
        const postsContainer = document.getElementById('postsContainer');
        const charCounter = document.getElementById('charCounter');

        // Character counter for textarea
        postContent.addEventListener('input', () => {
            charCounter.textContent = postContent.value.length;
        });

        // Function to generate a random anonymous identifier
        function generateAnonymousId() {
            const adjectives = ['Mysterious', 'Unknown', 'Secret', 'Hidden', 'Anonymous', 'Private', 'Ghostly', 'Shadowy', 'Incognito', 'Unseen'];
            const nouns = ['Stranger', 'Visitor', 'Phantom', 'Whisperer', 'Specter', 'Silhouette', 'Wanderer', 'Observer', 'Lurker', 'Presence'];
            const randomNumber = Math.floor(Math.random() * 10000);
            
            const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            
            return `${adjective}${noun}${randomNumber}`;
        }

        // Function to create a new post
        async function createPost() {
            const content = postContent.value.trim();
            if (!content) return;

            const anonymousId = localStorage.getItem('anonymousId') || generateAnonymousId();
            if (!localStorage.getItem('anonymousId')) {
                localStorage.setItem('anonymousId', anonymousId);
            }

            const { data, error } = await supabase
                .from('posts')
                .insert([
                    { 
                        content: content,
                        anonymous_id: anonymousId,
                        created_at: new Date().toISOString(),
                        expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                    }
                ])
                .select();

            if (error) {
                console.error('Error creating post:', error);
                alert('Failed to create post. Please try again.');
            } else {
                postContent.value = '';
                charCounter.textContent = '0';
                loadPosts();
            }
        }

        // Function to load posts from Supabase
        async function loadPosts() {
            // First delete expired posts
            await supabase
                .from('posts')
                .delete()
                .lt('expires_at', new Date().toISOString());

            // Then fetch active posts
            const { data: posts, error } = await supabase
                .from('posts')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading posts:', error);
                postsContainer.innerHTML = '<div class="bg-white rounded-lg shadow-lg p-6 fade-in"><p class="text-gray-700">Error loading posts. Please refresh the page.</p></div>';
                return;
            }

            if (posts.length === 0) {
                postsContainer.innerHTML = '<div class="bg-white rounded-lg shadow-lg p-6 fade-in"><p class="text-gray-700">No posts yet. Be the first to share something!</p></div>';
                return;
            }

            postsContainer.innerHTML = '';
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'bg-white rounded-lg shadow-lg p-6 fade-in post expiring';
                
                // Calculate time remaining in hours and minutes
                const expiresAt = new Date(post.expires_at);
                const now = new Date();
                const timeRemainingMs = expiresAt - now;
                const hoursRemaining = Math.floor(timeRemainingMs / (1000 * 60 * 60));
                const minutesRemaining = Math.floor((timeRemainingMs / (1000 * 60)) % 60);
                
                const isOwnPost = post.anonymous_id === localStorage.getItem('anonymousId');
                
                postElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <img src="https://placehold.co/40" alt="Anonymous user avatar - generic silhouette with ${post.anonymous_id.substring(0, 2)} initials in random color gradient" class="rounded-full w-10 h-10 mr-3">
                            <div>
                                <h3 class="font-medium text-gray-900">${post.anonymous_id}</h3>
                                <p class="text-xs text-gray-500">Posted ${formatTimeAgo(new Date(post.created_at))}</p>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            Expires in ${hoursRemaining}h ${minutesRemaining}m
                        </div>
                    </div>
                    <p class="text-gray-700 mt-3 mb-4">${post.content}</p>
                    ${isOwnPost ? '<button class="delete-post text-xs text-red-500 hover:text-red-700" data-id="' + post.id + '">Delete</button>' : ''}
                `;
                
                postsContainer.appendChild(postElement);
            });

            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-post').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const postId = e.target.getAttribute('data-id');
                    const { error } = await supabase
                        .from('posts')
                        .delete()
                        .eq('id', postId);
                    
                    if (error) {
                        console.error('Error deleting post:', error);
                        alert('Failed to delete post. Please try again.');
                    } else {
                        loadPosts();
                    }
                });
            });
        }

        // Function to format time ago
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval >= 1) return interval + " year" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return interval + " month" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return interval + " day" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + " hour" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + " minute" + (interval === 1 ? "" : "s") + " ago";
            
            return Math.floor(seconds) + " second" + (seconds === 1 ? "" : "s") + " ago";
        }

        // Event listeners
        postButton.addEventListener('click', createPost);
        postContent.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                createPost();
            }
        });

        // Initialize the app
        loadPosts();
        setInterval(loadPosts, 60000); // Refresh every minute

        // Create posts table if it doesn't exist
        async function initializeDatabase() {
            const { data: tableExists } = await supabase
                .from('pg_tables')
                .select('tablename')
                .eq('tablename', 'posts')
                .single();

            if (!tableExists) {
                const { error } = await supabase
                    .from('sql')
                    .insert([
                        { sql: 'CREATE TABLE IF NOT EXISTS posts (id SERIAL PRIMARY KEY, content TEXT NOT NULL, anonymous_id TEXT NOT NULL, created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(), expires_at TIMESTAMPTZ NOT NULL)' }
                    ]);
                
                if (error) {
                    console.error('Error creating posts table:', error);
                }
            }
        }

        initializeDatabase();
    </script>
</body>
</html>
